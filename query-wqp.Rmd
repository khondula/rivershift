---
title: "Query NWIS and Water Quality Portal for time series"
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
  html_notebook: 
    toc: yes
    toc_depth: 2
author: 'Kelly Hondula'
editor_options: 
  chunk_output_type: console
---


```{r setup, include = FALSE}
library(knitr)
opts_chunk$set(message = FALSE, warning = FALSE, out.width = '75%', cache = TRUE)
```

This notebook goes through searching the NWIS and WQP for time series of N, P, and chl. 

```{r, message = FALSE}
# devtools::install_github("USGS-R/dataRetrieval")
library(dataRetrieval)
library(dplyr)
library(lubridate)
library(glue)
library(ggplot2)
library(purrr)
library(readr)
library(DT)
library(stringr)
library(kableExtra)
```

Overview of data https://owi.usgs.gov/R/dataRetrieval.html#3

# Find Parameters Codes

There are 16,980 parameters, grouped into 16 categories and identified by unique 5 digit codes. Load the object `parameterCdFile` from the dataRetrieval package to browse them. 

```{r}
parameterCdFile <- dataRetrieval::parameterCdFile
unique(parameterCdFile$parameter_group_nm)
```

The column `parameter_nm` in the parameter code table contains longer descriptions. Use the `grep()` function to search the text in this column to find descriptions containing the word "phosphorus". 

## List of phosphorus codes

```{r}
phosCds_df <- parameterCdFile %>%
  filter(stringr::str_detect(parameter_nm, pattern = fixed('phosphorus', ignore_case = TRUE))) %>%
  filter(parameter_group_nm != "Information")

p_codes <- unique(phosCds_df$parameter_cd)
```


```{r, echo = FALSE, results='asis'}
DT::datatable(phosCds_df) 
```

## List of nitrogen codes

```{r}
nitCds_df <-  parameterCdFile %>%
  filter(stringr::str_detect(parameter_nm, pattern = fixed('nitrogen', ignore_case = TRUE))) %>%
  filter(!parameter_group_nm %in% c("Physical", "Inorganics, Major, Non-metals", "Stable Isotopes", "Toxicity"))
n_codes <- unique(nitCds_df$parameter_cd)
```


```{r, echo = FALSE, results='asis'}
DT::datatable(nitCds_df) 
```


## List of chl codes

```{r}
chlCds_df <- parameterCdFile %>%
  filter(stringr::str_detect(parameter_nm, pattern = fixed('chlorophyll', ignore_case = TRUE)))

chl_codes <- unique(chlCds_df$parameter_cd)
```

```{r, echo = FALSE, results='asis'}
DT::datatable(chlCds_df) 
```

Make a vector of all codes

```{r}
npc_codes <- c(chl_codes, n_codes, p_codes)
npc_codes1 <- npc_codes[1:100]
npc_codes2 <- npc_codes[101:200]
npc_codes3 <- npc_codes[201:length(npc_codes)]
npc_codes_df <- parameterCdFile %>% 
  filter(parameter_cd %in% npc_codes) %>%
  dplyr::select(parameter_cd, parameter_group_nm, parameter_nm, casrn, srsname, parameter_units) %>%
  mutate(category = case_when(parameter_cd %in% chl_codes ~ "chl",
                              parameter_cd %in% n_codes ~ "nitrogen",
                              parameter_cd %in% p_codes ~ "phosphorus"))
```

# NWIS water quality data

There needs to be at least one "major" filter for searching NWIS data. Strategy is to go through all the states to get a table of what is available through NWIS, using the built in vector of state abbreviations (`state.abb`)


Define function to save a csv file based on a state and set of parameter codes. use a code for the file name

```{r}
save_10yr_ts_nwis <- function(state_abbrev, my_codes, my_codes_cat = "chl"){
  whatNWISdata(stateCd = state_abbrev,
  parameterCd = my_codes) %>% 
  mutate(date_range_interval = ymd(begin_date) %--% ymd(end_date),
         date_range_yrs = suppressMessages(as.period(date_range_interval))/years()) %>%
  dplyr::filter(date_range_yrs > 10) %>%
  arrange(rev(date_range_yrs)) %>%
  readr::write_csv(glue("data/nwis_query_{my_codes_cat}-{state_abbrev}.csv"))
}
```

Use function to save file for each state and set of codes

```{r, eval = FALSE, cache=TRUE}
purrr::walk(state.abb, ~save_10yr_ts_nwis(state_abbrev = .x, 
                                     my_codes = chl_codes, 
                                     my_codes_cat = "chl"))

purrr::walk(state.abb, ~save_10yr_ts_nwis(state_abbrev = .x, 
                                     my_codes = p_codes, 
                                     my_codes_cat = "phos"))

# max 100 parameter codes so split up n codes
purrr::walk(state.abb, ~save_10yr_ts_nwis(state_abbrev = .x, 
                                     my_codes = n_codes[1:100], 
                                     my_codes_cat = "nitr1"))

purrr::walk(state.abb, ~save_10yr_ts_nwis(state_abbrev = .x, 
                                     my_codes = n_codes[101:length(n_codes)], 
                                     my_codes_cat = "nitr2"))
```

Read in all separate state files and combine, then Join with site codes information to convert parameter codes to names


```{r}
par_codes_for_join <- dplyr::select(parameterCdFile, parameter_cd, 
                                    parameter_nm, parameter_units)

nwis_chl_ts <- purrr::map_df(fs::dir_ls("data", regexp = "nwis.*chl"), ~readr::read_csv(.x, col_types = c("ccccddcccccc?c?c???c?DDn?n"))) %>%
  left_join(par_codes_for_join, by = c("parm_cd" = "parameter_cd"))

nwis_phos_ts <- purrr::map_df(fs::dir_ls("data", regexp = "nwis.*phos"), ~readr::read_csv(.x, col_types = c("ccccddcccccc?c?c???c?DDn?n"))) %>%
  left_join(par_codes_for_join, by = c("parm_cd" = "parameter_cd"))

nwis_nitr_ts <- purrr::map_df(fs::dir_ls("data", regexp = "nwis.*nitr"), ~readr::read_csv(.x, col_types = c("ccccddcccccc?c?c???c?DDn?n"))) %>%
  left_join(par_codes_for_join, by = c("parm_cd" = "parameter_cd"))

```

Save combined file 

```{r}
readr::write_csv(nwis_chl_ts, "chl_nwis_ts.csv")
readr::write_csv(nwis_phos_ts, "phos_nwis_ts.csv")
readr::write_csv(nwis_nitr_ts, "nitr_nwis_ts.csv")
```


```{r, include = FALSE}
kable(nwis_chl_ts) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

## Find sites that have P, N, and chl

Using site numbers

How many sites with both N and P?

12,579

```{r}
sites_NP <- nwis_nitr_ts %>% 
  filter(site_no %in% nwis_phos_ts$site_no) %>% 
  pull(site_no) %>% unique()
length(sites_NP)
```

How many sites with all 3? 

453 sites 

```{r}
sites_all3 <- nwis_nitr_ts %>% 
  filter(site_no %in% nwis_phos_ts$site_no) %>% 
  filter(site_no %in% nwis_chl_ts$site_no) %>%
  pull(site_no) %>% unique()

length(sites_all3)
```

## Get summary of N, P, chl parameters for a site

```{r}
site_id <- sites_all3[35]

get_nwis_site_data <- function(site_id){

    nwis_data_site <- purrr::map(list(npc_codes1, npc_codes2, npc_codes3),
                                 ~readNWISqw(siteNumbers = site_id,
                           parameterCd = .x)) %>%
    purrr::map(~mutate(.x, rpt_lev_va = as.character(rpt_lev_va))) %>% 
    purrr::map(~mutate(.x, sample_dt = as.character(sample_dt))) %>% 
    purrr::map(~mutate(.x, prep_set_no = as.character(prep_set_no))) %>% 
    bind_rows()
    
  
    readr::write_csv(nwis_data_site, 
                   glue::glue("data/nwis_site_data/nwis-data_{site_id}.csv"))
    
  nwis_data_site10yr <- nwis_data_site %>% 
    group_by(parm_cd) %>% 
    summarise(n_count = n(),
            min_datetime = as.Date(min(startDateTime)),
            max_datetime = as.Date(max(startDateTime)),
            min_year = lubridate::year(min(startDateTime)),
            max_year = lubridate::year(max(startDateTime))) %>%
  mutate(date_range_interval = ymd(min_datetime) %--% ymd(max_datetime),
         date_range_yrs = suppressMessages(as.period(date_range_interval))/years()) %>%
  left_join(npc_codes_df, by = c("parm_cd" = "parameter_cd")) %>%
  arrange(-n_count) %>% 
    filter(date_range_yrs > 10) %>%
        mutate(site_no = site_id) %>%
  dplyr::select(-min_datetime, -max_datetime, -date_range_interval)

  readr::write_csv(nwis_data_site10yr, 
                   glue::glue("data/nwis_site_summaries/nwis-summary_{site_id}.csv"))

  # return(nwis_data_site10yr)
}
```


```{r}
get_nwis_site_data(site_id = sites_all3[1])
purrr::walk(sites_all3, ~get_nwis_site_data(.x))

purrr::walk(sites_all3[347:length(sites_all3)], ~get_nwis_site_data(.x))
sites_all3[338] # no data? 
grep("14206425", sites_all3)
# read in all sites and save as one big table
# readr::write_csv(nwis_data_10yr_sums, "nwis_all3_10yr_summaries.csv")
```


## Get data values from NWIS

Example of getting data from one row of time series data frame with `readNWISqw` function.

```{r}
my_site <-  nwis_chl_ts$site_no[2]
my_param <- nwis_chl_ts$parm_cd[2]

chl_nwis_data_ex <- readNWISqw(siteNumbers = my_site,
                     parameterCd = my_param)

```

## Plot NWIS data

use attributes of the returned data frame

```{r}
varInfo <- attributes(chl_nwis_data_ex)[["variableInfo"]]
siteInfo <- attributes(chl_nwis_data_ex)[["siteInfo"]]

chl_nwis_data_ex %>%
  ggplot(aes(x = startDateTime, y = result_va)) +
  geom_point() +
  ylab(glue('{varInfo$srsname} ({varInfo$parameter_units})')) +
  xlab(element_blank()) +
  ggtitle(siteInfo$station_nm)
```

# Water Quality Portal 

That was searching NWIS, which is USGS data. The water quality portal includes data from states, EPA, USDA, etc. Note details about differences here: https://owi.usgs.gov/R/dataRetrieval.html#23. 

> There's not a function in WQP that returns period of record information like we did above via NWIS dataâ€¦(that feature may be implemented in the future). The following function returns sites that have collected phosphorus data in Wisconsin. There's no way to know if that site has collected one sample, or thousands.

Need to use characteristic names for all of WQP which [only seem to be available](https://github.com/USGS-R/dataRetrieval/issues/417) here: https://www.waterqualitydata.us/Codes/Characteristicname?mimeType=xml

**MonitoringLocationIdentifier**: A designator used to describe the unique name, number, or code assigned to identify the monitoring location.

```{r}
save_10yr_ts_wqp <- function(state_abbrev, 
                             char_name = "Phosphorus",
                             my_codes_cat = "phos"){
  
  char_Data <- readWQPdata(statecode = state_abbrev,
                           CharacteristicName = char_name)

  if(!is.null(char_Data)){
  siteInfo <- attr(char_Data, "siteInfo")

  char_Summary <- char_Data %>%
    group_by(MonitoringLocationIdentifier, 
             CharacteristicName,
             ResultMeasure.MeasureUnitCode) %>%
    summarise(count=n(),
            begin_datetime = min(ActivityStartDateTime),
            end_datetime = max(ActivityStartDateTime),
            max = max(ResultMeasureValue, na.rm = TRUE)) %>%
    arrange(-count) %>%
    left_join(siteInfo, by = "MonitoringLocationIdentifier")

  char_Summary_10yrs <- char_Summary %>%
    mutate(begin_date = as.Date(begin_datetime),
         end_date = as.Date(end_datetime)) %>%
    mutate(date_range_interval = ymd(begin_date) %--% ymd(end_date),
         date_range_yrs = 
           suppressMessages(as.period(date_range_interval))/years()) %>%
    dplyr::filter(date_range_yrs > 10) %>%
    arrange(-date_range_yrs)
  
  readr::write_csv(char_Summary_10yrs, 
                 glue("data/wqp_query_{my_codes_cat}-{state_abbrev}.csv"))    
  }

                             }


```

Run function over states to save results of 10 year + time series from WQP. This may include duplicates of what is in NWIS?

```{r, eval = FALSE, cache=TRUE}

purrr::walk(state.abb, ~save_10yr_ts_wqp(state_abbrev = .x, 
                                     char_name = "Phosphorus", 
                                     my_codes_cat = "phos"
                                     ))

purrr::walk(state.abb, ~save_10yr_ts_wqp(state_abbrev = .x, 
                                     char_name = "Chlorophyll",  
                                     my_codes_cat = "chl"))

purrr::walk(state.abb, ~save_10yr_ts_wqp(state_abbrev = .x, 
                                     char_name = "Nitrogen", 
                                     my_codes_cat = "nitr"))

```

Read in groups of CSV files to save summary tables for all states for each parameter

```{r}

wqp_col_types <- cols("begin_date" = "D", 
                      "end_date" = "D", 
                      "hucCd" = "c",
                      "HUCEightDigitCode" = "c",
                      "VerticalAccuracyMeasure.MeasureValue" = "n",
                      "HorizontalAccuracyMeasure.MeasureValue" = "n",
                      "VerticalMeasure.MeasureValue" = "n",
                      "StateCode" = "i",
                      "CountyCode" = "c",
                      "ConstructionDateText" = "c",
                      "WellDepthMeasure.MeasureValue" = "c",
                      "WellHoleDepthMeasure.MeasureValue" = "c",
                      "count" = "n",
                      "begin_datetime" = "D",
                      "end_datetime" = "D",
                      "max" = "n",
                      "dec_lat_va" = "n",
                      "dec_lon_va" = "n",
                      "LatitudeMeasure" = "n",
                      "LongitudeMeasure" = "n",
                      "date_range_interval" = "c",
                      "date_range_yrs" = "n",
                      "DrainageAreaMeasure.MeasureValue" = "n",
                      "ContributingDrainageAreaMeasure.MeasureValue" = "n",
                      "SourceMapScaleNumeric" = "n")

wqp_phos_ts <- purrr::map_df(fs::dir_ls("data", regexp = "wqp.*phos"),
                              ~readr::read_csv(.x, col_types = wqp_col_types))

wqp_nitr_ts <- purrr::map_df(fs::dir_ls("data", regexp = "wqp.*nitr"),
                              ~readr::read_csv(.x, col_types = wqp_col_types))

wqp_chl_ts <- purrr::map_df(fs::dir_ls("data", regexp = "wqp.*chl"),
                              ~readr::read_csv(.x, col_types = wqp_col_types))

```

```{r}
wqp_phos_ts %>% readr::write_csv("phos_wqp_ts.csv")
wqp_nitr_ts %>% readr::write_csv("nitr_wqp_ts.csv")
wqp_chl_ts %>% readr::write_csv("chl_wqp_ts.csv")
```

