---
title: "Query NWIS for time series"
output: 
  html_notebook: 
    toc: yes
    toc_depth: 2
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
author: 'Kelly Hondula'
editor_options: 
  chunk_output_type: inline
---


```{r setup, include = FALSE}
library(knitr)
opts_chunk$set(message = FALSE, warning = FALSE, out.width = '75%', cache = TRUE)
```

This notebook goes through searching the NWIS and WQP for time series of N, P, and chl. 

```{r, message = FALSE}
# devtools::install_github("USGS-R/dataRetrieval")
library(dataRetrieval)
library(dplyr)
library(lubridate)
library(glue)
library(ggplot2)
library(purrr)
library(readr)
```

Overview of data https://owi.usgs.gov/R/dataRetrieval.html#3

# Find Parameters Codes

There are 16,980 parameters, grouped into 16 categories and identified by unique 5 digit codes. Load the object `parameterCdFile` from the dataRetrieval package to browse them. 

```{r}
parameterCdFile <- dataRetrieval::parameterCdFile
unique(parameterCdFile$parameter_group_nm)
```

The column `parameter_nm` in the parameter code table contains longer descriptions. Use the `grep()` function to search the text in this column to find descriptions containing the word "phosphorus". 

```{r}
names(parameterCdFile)
phosCds_df <- parameterCdFile[grep("phosphorus",
                                parameterCdFile$parameter_nm,
                                ignore.case=TRUE),]
unique(phosCds_df$parameter_nm)
p_codes <- unique(phosCds_df$parameter_cd)
```

```{r}
nitCds_df <- parameterCdFile[grep("nitrogen",
                                parameterCdFile$parameter_nm,
                                ignore.case=TRUE),]
unique(nitCds_df$parameter_nm)
n_codes <- unique(nitCds_df$parameter_cd)
```

List of chl codes

```{r}
chlCds_df <- parameterCdFile[grep("chlorophyll",
                                parameterCdFile$parameter_nm,
                                ignore.case=TRUE),]
unique(chlCds_df$parameter_nm)
chl_codes <- unique(chlCds_df$parameter_cd)
```


# Search NWIS water quality data

There needs to be at least one "major" filter for searching NWIS data. Strategy is to go through all the states to get a table of what is available through NWIS, using the built in vector of state abbreviations (`state.abb`)


Define function to save a csv file based on a state and set of parameter codes. use a code for the file name

```{r}
save_10yr_ts <- function(state_abbrev, my_codes, my_codes_cat = "chl"){
  whatNWISdata(stateCd = state_abbrev,
  parameterCd = my_codes) %>% 
  mutate(date_range_interval = ymd(begin_date) %--% ymd(end_date),
         date_range_yrs = suppressMessages(as.period(date_range_interval))/years()) %>%
  dplyr::filter(date_range_yrs > 10) %>%
  arrange(rev(date_range_yrs)) %>%
  readr::write_csv(glue("data/nwis_query_{my_codes_cat}-{state_abbrev}.csv"))
}
```

Use function to save file for each state and set of codes

```{r, eval = FALSE, cache=TRUE}
purrr::walk(state.abb, ~save_10yr_ts(state_abbrev = .x, 
                                     my_codes = chl_codes, 
                                     my_codes_cat = "chl"))

purrr::walk(state.abb, ~save_10yr_ts(state_abbrev = .x, 
                                     my_codes = p_codes, 
                                     my_codes_cat = "phos"))

# max 100 parameter codes so split up n codes
purrr::walk(state.abb, ~save_10yr_ts(state_abbrev = .x, 
                                     my_codes = n_codes[1:100], 
                                     my_codes_cat = "nitr1"))

purrr::walk(state.abb, ~save_10yr_ts(state_abbrev = .x, 
                                     my_codes = n_codes[101:178], 
                                     my_codes_cat = "nitr2"))
```

Read in all separate state files and combine, then Join with site codes information to convert parameter codes to names


```{r}
par_codes_for_join <- dplyr::select(parameterCdFile, parameter_cd, 
                                    parameter_nm, parameter_units)

nwis_chl_ts <- purrr::map_df(fs::dir_ls("data", regexp = "chl"), ~readr::read_csv(.x, col_types = c("ccccddcccccc?c?c???c?DDn?n"))) %>%
  left_join(par_codes_for_join, by = c("parm_cd" = "parameter_cd"))

nwis_phos_ts <- purrr::map_df(fs::dir_ls("data", regexp = "phos"), ~readr::read_csv(.x, col_types = c("ccccddcccccc?c?c???c?DDn?n"))) %>%
  left_join(par_codes_for_join, by = c("parm_cd" = "parameter_cd"))

nwis_nitr_ts <- purrr::map_df(fs::dir_ls("data", regexp = "nitr"), ~readr::read_csv(.x, col_types = c("ccccddcccccc?c?c???c?DDn?n"))) %>%
  left_join(par_codes_for_join, by = c("parm_cd" = "parameter_cd"))

```

Save combined file 

```{r}
readr::write_csv(nwis_chl_ts, "chl_nwis_ts.csv")
readr::write_csv(nwis_phos_ts, "phos_nwis_ts.csv")
readr::write_csv(nwis_nitr_ts, "nitr_nwis_ts.csv")
```

## Get data values from NWIS

Example of getting data from first time series with `readNWISdata` function.

```{r}
my_site <-  nwis_chl_ts$site_no[2]
my_param <- nwis_chl_ts$parm_cd[2]

chl_nwis_data_ex <- readNWISqw(siteNumbers = my_site,
                     parameterCd = my_param)

```

## Plot NWIS data

use attributes of the returned data frame

```{r}
varInfo <- attributes(chl_nwis_data_ex)[["variableInfo"]]
siteInfo <- attributes(chl_nwis_data_ex)[["siteInfo"]]

chl_nwis_data_ex %>%
  ggplot(aes(x = startDateTime, y = result_va)) +
  geom_point() +
  ylab(glue('{varInfo$srsname} ({varInfo$parameter_units})')) +
  xlab(element_blank()) +
  ggtitle(siteInfo$station_nm)
```

# Water Quality Portal 

# Daily data

```{r}
?readNWISdv
```

# Water quality data


```{r}
?readNWISqw
# readNWISqw(siteNumbers, parameterCd, 
#            startDate = "",
#            endDate = "",
#            expanded = TRUE,
#            reshape = FALSE)
```

# Site info

```{r}
?readNWISsite
```

